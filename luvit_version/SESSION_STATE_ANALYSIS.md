# ä¼šè¯çŠ¶æ€ç®¡ç†åˆ†æ

## å½“å‰çŠ¶æ€ç®¡ç†æƒ…å†µ

### âœ… å·²è¿ç§»åˆ° SessionManager

1. **NoNo è·ŸéšçŠ¶æ€**
   - ä½ç½®ï¼š`sessionManager.tempStates.nonoFollowing`
   - APIï¼š`setNonoFollowing()`, `getNonoFollowing()`
   - çŠ¶æ€ï¼šâœ… å·²å®Œæˆ

### âš ï¸ ä»åœ¨ä½¿ç”¨ç‹¬ç«‹æ¨¡å—

#### 1. OnlineTracker (åœ¨çº¿è¿½è¸ªå™¨)
**å½“å‰ä½ç½®**ï¼š`handlers/online_tracker.lua`

**åŠŸèƒ½**ï¼š
- ç©å®¶ä¸Šçº¿/ä¸‹çº¿è¿½è¸ª
- åœ°å›¾ç©å®¶è¿½è¸ª
- åœ°å›¾äººæ•°ç»Ÿè®¡
- ç©å®¶å¹¿æ’­åŠŸèƒ½
- clientData å­˜å‚¨ï¼ˆç”¨äºå‘é€æ¶ˆæ¯ï¼‰

**æ•°æ®ç»“æ„**ï¼š
```lua
onlinePlayers = {
    [userId] = {
        mapId = 0,
        mapType = 0,
        loginTime = os.time(),
        lastActive = os.time(),
        clientData = clientData  -- socket è¿æ¥
    }
}

mapPlayerCount = {
    [mapId] = count
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- åœ°å›¾ç©å®¶åˆ—è¡¨ï¼ˆCMD 2003ï¼‰
- åœ°å›¾çƒ­åº¦ç»Ÿè®¡ï¼ˆCMD 1004ï¼‰
- ç©å®¶ç§»åŠ¨å¹¿æ’­ï¼ˆCMD 2101ï¼‰
- èŠå¤©å¹¿æ’­ï¼ˆCMD 2102ï¼‰
- æœè£…å˜æ›´å¹¿æ’­ï¼ˆCMD 2604ï¼‰

**å»ºè®®**ï¼š
- âš ï¸ **ä¿ç•™ OnlineTracker**ï¼Œä½†ä¸ SessionManager é›†æˆ
- OnlineTracker ä¸“æ³¨äº**ç½‘ç»œè¿æ¥å’Œæ¶ˆæ¯å¹¿æ’­**
- SessionManager ä¸“æ³¨äº**ä¸šåŠ¡çŠ¶æ€ç®¡ç†**
- ä¸¤è€…äº’è¡¥ï¼Œä¸å†²çª

#### 2. clientData (å®¢æˆ·ç«¯è¿æ¥æ•°æ®)
**å½“å‰ä½ç½®**ï¼šæ¸¸æˆæœåŠ¡å™¨å’Œæˆ¿é—´æœåŠ¡å™¨çš„ `clients` æ•°ç»„

**å­˜å‚¨çš„æ•°æ®**ï¼š
```lua
clientData = {
    socket = client,           -- TCP socket è¿æ¥
    buffer = "",               -- æ¥æ”¶ç¼“å†²åŒº
    userId = 0,                -- ç”¨æˆ·ID
    session = "",              -- ä¼šè¯ID
    seqId = 0,                 -- åºåˆ—å·
    heartbeatTimer = nil,      -- å¿ƒè·³å®šæ—¶å™¨
    loggedIn = false,          -- æ˜¯å¦å·²ç™»å½•
    
    -- æˆ¿é—´æœåŠ¡å™¨ç‰¹æœ‰
    roomId = 0,                -- æˆ¿é—´ID
    targetUserId = 0,          -- ç›®æ ‡ç”¨æˆ·ID
    nonoState = 0,             -- NoNo çŠ¶æ€ï¼ˆä¼šè¯çº§ï¼‰
    
    -- æ¸¸æˆæœåŠ¡å™¨ç‰¹æœ‰
    nonoFollowing = false,     -- NoNo è·Ÿéšï¼ˆä¼šè¯çº§ï¼‰
}
```

**å»ºè®®**ï¼š
- âœ… **ä¿ç•™ clientData**ï¼Œå®ƒæ˜¯**ç½‘ç»œå±‚æ•°æ®**
- clientData å­˜å‚¨è¿æ¥ç›¸å…³çš„æ•°æ®ï¼ˆsocket, buffer, timerï¼‰
- SessionManager å­˜å‚¨ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„æ•°æ®ï¼ˆçŠ¶æ€ã€ä¸´æ—¶æ•°æ®ï¼‰

### ğŸ”„ éœ€è¦è¿ç§»çš„çŠ¶æ€

#### 1. æˆ˜æ–—çŠ¶æ€
**å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°
**å»ºè®®**ï¼šä½¿ç”¨ SessionManager

```lua
-- åˆ›å»ºæˆ˜æ–—
sessionManager:createBattle(userId, {
    battleType = 'wild',  -- 'wild', 'npc', 'pvp', 'boss'
    monsterId = 123,
    round = 1,
    playerPet = {...},
    enemyPet = {...},
})

-- æ£€æŸ¥æ˜¯å¦åœ¨æˆ˜æ–—ä¸­
if sessionManager:isInBattle(userId) then
    -- æˆ˜æ–—ä¸­ï¼Œä¸èƒ½æ‰§è¡Œå…¶ä»–æ“ä½œ
end

-- æ›´æ–°æˆ˜æ–—çŠ¶æ€
sessionManager:updateBattle(userId, {round = 2})

-- ç»“æŸæˆ˜æ–—
sessionManager:endBattle(userId)
```

#### 2. äº¤æ˜“çŠ¶æ€
**å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°
**å»ºè®®**ï¼šä½¿ç”¨ SessionManager

```lua
-- åˆ›å»ºäº¤æ˜“
local tradeId = sessionManager:createTrade(userId1, userId2, {
    items1 = {},
    items2 = {},
    confirmed1 = false,
    confirmed2 = false,
})

-- è·å–äº¤æ˜“çŠ¶æ€
local trade = sessionManager:getTrade(userId)

-- ç»“æŸäº¤æ˜“
sessionManager:endTrade(tradeId)
```

#### 3. ç»„é˜ŸçŠ¶æ€
**å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°
**å»ºè®®**ï¼šä½¿ç”¨ SessionManager

```lua
-- åˆ›å»ºé˜Ÿä¼
sessionManager:createTeam(leaderId, {
    members = {userId1, userId2},
    maxMembers = 4,
})

-- è·å–é˜Ÿä¼
local team = sessionManager:getTeam(userId)

-- è§£æ•£é˜Ÿä¼
sessionManager:disbandTeam(leaderId)
```

#### 4. é‚€è¯·çŠ¶æ€
**å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°
**å»ºè®®**ï¼šä½¿ç”¨ SessionManager

```lua
-- åˆ›å»ºé‚€è¯·
local inviteId = sessionManager:createInvite(fromUserId, toUserId, 'friend', {
    message = "åŠ ä¸ªå¥½å‹å§"
})

-- è·å–ç”¨æˆ·çš„æ‰€æœ‰é‚€è¯·
local invites = sessionManager:getUserInvites(userId)

-- åˆ é™¤é‚€è¯·
sessionManager:removeInvite(inviteId)
```

## æ¶æ„å»ºè®®

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¸šåŠ¡é€»è¾‘å±‚ (Handlers)                    â”‚
â”‚  - å‘½ä»¤å¤„ç†                                               â”‚
â”‚  - ä¸šåŠ¡è§„åˆ™                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SessionManager         â”‚  â”‚   OnlineTracker          â”‚
â”‚   (ä¸šåŠ¡çŠ¶æ€ç®¡ç†)          â”‚  â”‚   (è¿æ¥å’Œå¹¿æ’­)            â”‚
â”‚  - NoNo çŠ¶æ€             â”‚  â”‚  - åœ¨çº¿ç©å®¶              â”‚
â”‚  - æˆ˜æ–—çŠ¶æ€              â”‚  â”‚  - åœ°å›¾è¿½è¸ª              â”‚
â”‚  - äº¤æ˜“çŠ¶æ€              â”‚  â”‚  - æ¶ˆæ¯å¹¿æ’­              â”‚
â”‚  - ç»„é˜ŸçŠ¶æ€              â”‚  â”‚  - clientData å­˜å‚¨       â”‚
â”‚  - é‚€è¯·çŠ¶æ€              â”‚  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç½‘ç»œå±‚ (Servers)                         â”‚
â”‚  - TCP Socket ç®¡ç†                                        â”‚
â”‚  - æ•°æ®åŒ…è§£æ                                             â”‚
â”‚  - clientData (buffer, socket, timer)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èŒè´£åˆ’åˆ†

#### SessionManager (ä¸šåŠ¡çŠ¶æ€ç®¡ç†)
- âœ… ç®¡ç†ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„çŠ¶æ€
- âœ… è·¨æœåŠ¡å™¨çŠ¶æ€åŒæ­¥
- âœ… ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… å®šæ—¶æ¸…ç†å’Œç»Ÿè®¡
- âŒ ä¸ç®¡ç†ç½‘ç»œè¿æ¥
- âŒ ä¸è´Ÿè´£æ¶ˆæ¯å‘é€

#### OnlineTracker (è¿æ¥å’Œå¹¿æ’­)
- âœ… ç®¡ç†ç©å®¶åœ¨çº¿çŠ¶æ€
- âœ… è¿½è¸ªç©å®¶æ‰€åœ¨åœ°å›¾
- âœ… æä¾›æ¶ˆæ¯å¹¿æ’­åŠŸèƒ½
- âœ… å­˜å‚¨ clientDataï¼ˆç”¨äºå‘é€æ¶ˆæ¯ï¼‰
- âŒ ä¸ç®¡ç†ä¸šåŠ¡çŠ¶æ€

#### clientData (ç½‘ç»œå±‚æ•°æ®)
- âœ… å­˜å‚¨ socket è¿æ¥
- âœ… å­˜å‚¨æ¥æ”¶ç¼“å†²åŒº
- âœ… å­˜å‚¨å¿ƒè·³å®šæ—¶å™¨
- âœ… å­˜å‚¨è¿æ¥ç›¸å…³çš„ä¸´æ—¶æ•°æ®
- âŒ ä¸å­˜å‚¨ä¸šåŠ¡çŠ¶æ€

## é›†æˆæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¿æŒç°çŠ¶ï¼ˆæ¨èï¼‰âœ…

**ä¼˜ç‚¹**ï¼š
- èŒè´£æ¸…æ™°ï¼Œå„å¸å…¶èŒ
- OnlineTracker ä¸“æ³¨äºç½‘ç»œå±‚
- SessionManager ä¸“æ³¨äºä¸šåŠ¡å±‚
- ä¸éœ€è¦å¤§è§„æ¨¡é‡æ„

**ç¼ºç‚¹**ï¼š
- ä¸¤ä¸ªæ¨¡å—éœ€è¦ååŒå·¥ä½œ
- å¯èƒ½å­˜åœ¨æ•°æ®é‡å¤

**å®ç°**ï¼š
```lua
-- ç©å®¶ä¸Šçº¿æ—¶
sessionManager:userOnline(userId, 'game', mapId)
OnlineTracker.playerLogin(userId, clientData)

-- ç©å®¶ä¸‹çº¿æ—¶
sessionManager:userOffline(userId)
OnlineTracker.playerLogout(userId)

-- æ›´æ–°åœ°å›¾æ—¶
sessionManager:updateUserMap(userId, mapId)
OnlineTracker.updatePlayerMap(userId, mapId, mapType)
```

### æ–¹æ¡ˆ 2: åˆå¹¶åˆ° SessionManagerï¼ˆä¸æ¨èï¼‰âŒ

**ä¼˜ç‚¹**ï¼š
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰çŠ¶æ€
- å‡å°‘æ¨¡å—æ•°é‡

**ç¼ºç‚¹**ï¼š
- SessionManager èŒè´£è¿‡é‡
- éœ€è¦å¤§è§„æ¨¡é‡æ„
- ç½‘ç»œå±‚å’Œä¸šåŠ¡å±‚è€¦åˆ

## å½“å‰çŠ¶æ€æ€»ç»“

### âœ… å·²å®Œæˆ
1. NoNo è·ŸéšçŠ¶æ€ â†’ SessionManager
2. ä¼šè¯ç®¡ç†åŸºç¡€è®¾æ–½
3. å®šæ—¶æ¸…ç†å’Œç»Ÿè®¡

### âš ï¸ ä¿æŒç‹¬ç«‹
1. OnlineTracker â†’ ä¸“æ³¨äºè¿æ¥å’Œå¹¿æ’­
2. clientData â†’ ä¸“æ³¨äºç½‘ç»œå±‚æ•°æ®

### ğŸ”œ å¾…å®ç°
1. æˆ˜æ–—çŠ¶æ€ â†’ SessionManager
2. äº¤æ˜“çŠ¶æ€ â†’ SessionManager
3. ç»„é˜ŸçŠ¶æ€ â†’ SessionManager
4. é‚€è¯·çŠ¶æ€ â†’ SessionManager

## å»ºè®®

1. **ä¿æŒ OnlineTracker ç‹¬ç«‹** - å®ƒä¸“æ³¨äºç½‘ç»œå±‚ï¼Œä¸ SessionManager äº’è¡¥
2. **ä¿æŒ clientData ç‹¬ç«‹** - å®ƒæ˜¯ç½‘ç»œå±‚æ•°æ®ï¼Œä¸åº”è¯¥æ”¾å…¥ SessionManager
3. **æ–°å¢ä¸šåŠ¡çŠ¶æ€ä½¿ç”¨ SessionManager** - æˆ˜æ–—ã€äº¤æ˜“ã€ç»„é˜Ÿç­‰
4. **ä¸¤è€…ååŒå·¥ä½œ** - åœ¨å…³é”®ç‚¹åŒæ—¶æ›´æ–°ä¸¤ä¸ªæ¨¡å—

è¿™æ ·çš„æ¶æ„æ¸…æ™°ã€èŒè´£æ˜ç¡®ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ï¼
