# 服装同步测试指南

## 测试步骤

### 1. 检查初始状态
```bash
# 查看 users.json 中的 clothes 字段
# 应该是空数组 []
```

### 2. 在游戏中换衣服
- 进入游戏
- 打开背包，选择一件衣服
- 点击"穿上"按钮
- 观察日志输出

**期望日志**：
```
[LocalGame] 处理 CMD 2604: 更换服装
[LocalGame] 更换服装: 1 件
[UserDB] 保存游戏数据: userId=100000001, 任务数=X
[LocalGame] 用户 100000001 服装已保存到数据库
✓ [CHANGE_CLOTH] 包体大小正确: 16字节
```

### 3. 检查数据库
```bash
# 查看 users.json 中的 clothes 字段
# 应该包含刚才穿上的衣服
# 例如: "clothes": [{"id": 100028, "level": 1}]
```

### 4. 在房间内换衣服
- 进入家园
- 打开背包，换另一件衣服
- 观察日志输出

**期望日志**：
```
[RoomServer] 收到 CMD=2604 (CHANGE_CLOTH)
[LocalGame] 处理 CMD 2604: 更换服装
[LocalGame] 更换服装: 1 件
[UserDB] 保存游戏数据: userId=100000001
[LocalGame] 用户 100000001 服装已保存到数据库
[RoomServer] 清除用户 100000001 的缓存（衣服已更新）
```

### 5. 查看身上的衣服
- 在房间内，观察角色身上的衣服
- 应该显示刚才换上的衣服

### 6. 重新登录
- 退出游戏
- 重新登录
- 观察日志输出

**期望日志**：
```
[LOGIN] 加载了 1 件服装
✓ [LOGIN_IN] 包体大小正确: 1154字节 (1件服装)
```

### 7. 进入地图
- 进入任意地图
- 观察日志输出

**期望日志**：
```
✓ [ENTER_MAP] 包体大小正确: 152字节 (1件服装)
```

## 常见问题

### 问题1：换衣服后没有保存
**症状**：日志中没有"服装已保存到数据库"
**原因**：handleChangeCloth 没有被调用
**解决**：检查命令路由是否正确

### 问题2：保存了但重新登录后消失
**症状**：users.json 中有 clothes 数据，但登录时没有加载
**原因**：seer_login_response.lua 没有读取 clothes
**解决**：检查登录响应代码

### 问题3：房间内换衣服后不同步
**症状**：背包显示新衣服，但身上显示旧衣服
**原因**：RoomServer 缓存没有清除
**解决**：检查 RoomServer 的 handleCommand 是否清除缓存

### 问题4：ENTER_MAP 包体大小错误
**症状**：协议验证器报错"包体大小不匹配"
**原因**：clothes 数据没有正确发送
**解决**：检查 handleEnterMap 是否包含 clothes 数据

## 调试技巧

### 1. 查看十六进制数据
在日志中找到 CHANGE_CLOTH 的包体详情：
```
[PACKET] CMD=2604 包体详情 (16 bytes):
  0000: 05 F5 E1 01 00 00 00 01 00 01 86 BC 00 00 00 01
```

解析：
- `05 F5 E1 01` = userId (100000001)
- `00 00 00 01` = clothCount (1)
- `00 01 86 BC` = clothId (100028)
- `00 00 00 01` = clothType/level (1)

### 2. 查看 ENTER_MAP 数据
```
[PACKET] CMD=2001 包体详情 (152 bytes):
  ...
  0080: 00 00 00 00 00 00 00 00 00 00 00 01 00 01 86 BC
  0090: 00 00 00 01 00 00 00 00
```

最后12字节：
- `00 00 00 01` = clothCount (1)
- `00 01 86 BC` = clothId (100028)
- `00 00 00 01` = level (1)
- `00 00 00 00` = curTitle (0)

### 3. 对比官服数据
使用官服代理模式，对比官服的 ENTER_MAP 数据格式：
```
官服: 00 00 00 05 00 01 87 95 00 00 00 01 ... (5件衣服)
本地: 00 00 00 01 00 01 86 BC 00 00 00 01 ... (1件衣服)
```

格式应该完全一致！

## 测试日期

2026年1月17日
