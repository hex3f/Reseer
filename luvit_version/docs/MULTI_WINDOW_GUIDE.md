# 多窗口启动指南

## 概述

新的多窗口启动模式将服务器分为三个独立的进程，每个进程在独立的窗口中运行，便于监控和调试。

## 架构

```
┌─────────────────────────────────────────────────────────┐
│                  启动脚本 (start.bat)                     │
│  - 启动三个独立窗口                                        │
│  - 管理进程生命周期                                        │
└─────────────────────────────────────────────────────────┘
         │              │              │
         ↓              ↓              ↓
┌────────────┐  ┌────────────┐  ┌────────────┐
│ 数据管理器  │  │ 游戏服务器  │  │ 房间服务器  │
│ (端口 5200)│  │ (端口 5000)│  │ (端口 5100)│
└────────────┘  └────────────┘  └────────────┘
```

## 三个服务器

### 1. 数据管理服务器 (Data Manager)
**端口**: 5200  
**文件**: `start_dataserver.lua`

**职责**：
- 会话管理 (SessionManager)
- 用户数据库 (UserDB)
- 统计监控
- 定时清理任务

**API 端点**：
- `GET /api/stats` - 获取统计信息
- `GET /api/online` - 获取在线用户列表
- `GET /api/user/:id` - 获取用户信息
- `GET /api/health` - 健康检查

**特点**：
- 提供 HTTP API 供其他服务器查询
- 每 30 秒自动保存用户数据
- 每 10 分钟打印统计信息

### 2. 游戏服务器 (Game Server)
**端口**: 5000  
**文件**: `start_gameserver.lua`

**职责**：
- 游戏逻辑处理
- 地图系统
- 战斗系统
- 精灵系统
- 物品系统

**特点**：
- 预加载所有游戏数据（精灵、技能、物品）
- 连接到数据管理服务器获取会话和用户数据
- 处理所有游戏相关的命令

### 3. 房间服务器 (Room Server)
**端口**: 5100  
**文件**: `start_roomserver.lua`

**职责**：
- 家园系统
- 家具系统
- 房间功能
- NoNo 管理

**特点**：
- 连接到数据管理服务器和游戏服务器
- 共享命令处理器
- 独立的房间逻辑

## 启动方式

### 方式 1: 使用启动脚本（推荐）

```bash
# Windows
start.bat

# 或双击 start.bat 文件
```

启动脚本会自动：
1. 启动数据管理服务器（等待 2 秒）
2. 启动游戏服务器（等待 2 秒）
3. 启动房间服务器

### 方式 2: 手动启动

```bash
# 窗口 1: 数据管理服务器
luvit start_dataserver.lua

# 窗口 2: 游戏服务器（等待数据服务器启动后）
luvit start_gameserver.lua

# 窗口 3: 房间服务器（等待游戏服务器启动后）
luvit start_roomserver.lua
```

**注意**: 必须按顺序启动，因为后面的服务器依赖前面的服务器。

## 停止服务器

### 方式 1: 关闭窗口
直接关闭各个服务器窗口即可。

### 方式 2: Ctrl+C
在各个窗口中按 `Ctrl+C` 停止服务器。

**注意**: 数据管理服务器会在停止时自动保存所有数据。

## 监控和调试

### 查看统计信息

**方式 1**: 在数据管理服务器窗口中输入 `stats` 并按回车

**方式 2**: 访问 HTTP API
```bash
curl http://127.0.0.1:5200/api/stats
```

**方式 3**: 在浏览器中打开
```
http://127.0.0.1:5200/api/stats
```

### 查看在线用户

```bash
curl http://127.0.0.1:5200/api/online
```

### 查看特定用户

```bash
curl http://127.0.0.1:5200/api/user/100000001
```

## 日志分离

每个服务器窗口显示各自的日志：

- **数据管理服务器**: 会话管理、数据保存、统计信息
- **游戏服务器**: 游戏命令、战斗日志、地图事件
- **房间服务器**: 房间命令、家具操作、NoNo 事件

这样可以更清晰地查看和调试各个模块的运行情况。

## 优势

### 1. 清晰的日志分离
- 每个服务器的日志在独立窗口中显示
- 不会混在一起，便于调试

### 2. 独立监控
- 可以单独监控每个服务器的状态
- 查看各个服务器的资源使用情况

### 3. 易于调试
- 可以单独重启某个服务器
- 不影响其他服务器的运行

### 4. 模块化架构
- 数据与逻辑分离
- 便于扩展和维护

### 5. 生产级部署
- 可以轻松迁移到多机器部署
- 每个服务器可以独立扩展

## 注意事项

### 1. 启动顺序
必须按照以下顺序启动：
1. 数据管理服务器（最先）
2. 游戏服务器
3. 房间服务器（最后）

### 2. 进程间通信
当前使用全局变量 (`_G`) 进行进程间通信，这只在单机部署时有效。

如果需要多机器部署，需要修改为：
- HTTP/REST API
- TCP Socket
- Redis/消息队列

### 3. 数据一致性
所有服务器共享同一个数据管理服务器，确保数据一致性。

### 4. 端口占用
确保以下端口未被占用：
- 5200 (数据管理服务器)
- 5000 (游戏服务器)
- 5100 (房间服务器)

## 故障排除

### 问题 1: 服务器启动失败

**原因**: 端口被占用

**解决**:
```bash
# 检查端口占用
netstat -ano | findstr "5200"
netstat -ano | findstr "5000"
netstat -ano | findstr "5100"

# 关闭占用端口的进程
taskkill /PID <进程ID> /F
```

### 问题 2: 服务器无法连接

**原因**: 启动顺序错误

**解决**: 按照正确的顺序重新启动服务器

### 问题 3: 数据未保存

**原因**: 数据管理服务器异常退出

**解决**: 
- 使用 `Ctrl+C` 正常停止服务器
- 检查数据管理服务器的日志

## 与单窗口模式对比

### 单窗口模式 (reseer.lua)
- ✅ 简单易用
- ✅ 适合开发测试
- ❌ 日志混在一起
- ❌ 难以调试
- ❌ 无法独立监控

### 多窗口模式 (start.bat)
- ✅ 日志分离清晰
- ✅ 易于调试
- ✅ 独立监控
- ✅ 模块化架构
- ✅ 生产级部署
- ❌ 启动稍复杂

## 建议

- **开发测试**: 使用单窗口模式 (`luvit reseer.lua`)
- **生产部署**: 使用多窗口模式 (`start.bat`)
- **调试问题**: 使用多窗口模式，便于查看日志

## 未来扩展

### 1. 多机器部署
将三个服务器部署到不同的机器上：
- 数据管理服务器: 192.168.1.10:5200
- 游戏服务器: 192.168.1.11:5000
- 房间服务器: 192.168.1.12:5100

### 2. 负载均衡
启动多个游戏服务器实例：
- 游戏服务器 1: 192.168.1.11:5000
- 游戏服务器 2: 192.168.1.12:5000
- 游戏服务器 3: 192.168.1.13:5000

### 3. 高可用
- 数据管理服务器主从复制
- 游戏服务器集群
- 房间服务器集群

### 4. 监控系统
- Prometheus + Grafana
- 实时监控各服务器状态
- 告警系统

这是一个可扩展的、生产级的架构！🚀
