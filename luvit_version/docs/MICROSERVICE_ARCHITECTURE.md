# å¾®æœåŠ¡æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®æœåŠ¡å™¨ (Data Server)                     â”‚
â”‚                   HTTP API (ç«¯å£ 5200)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·æ•°æ®ç®¡ç† (UserDB)                              â”‚   â”‚
â”‚  â”‚ â€¢ ä¼šè¯ç®¡ç† (SessionManager)                          â”‚   â”‚
â”‚  â”‚ â€¢ çŠ¶æ€åŒæ­¥ (NoNo, Battle, Trade)                    â”‚   â”‚
â”‚  â”‚ â€¢ æ•°æ®æŒä¹…åŒ– (users.json)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–²
                         â”‚ HTTP API è°ƒç”¨
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¸¸æˆæœåŠ¡å™¨ (5000)  â”‚      â”‚  æˆ¿é—´æœåŠ¡å™¨ (5100)   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DataClient    â”‚ â”‚      â”‚  â”‚ DataClient     â”‚ â”‚
â”‚  â”‚ â†“             â”‚ â”‚      â”‚  â”‚ â†“              â”‚ â”‚
â”‚  â”‚ æ¸¸æˆé€»è¾‘      â”‚ â”‚      â”‚  â”‚ å®¶å›­ç³»ç»Ÿ       â”‚ â”‚
â”‚  â”‚ åœ°å›¾/æˆ˜æ–—     â”‚ â”‚      â”‚  â”‚ NoNo ç³»ç»Ÿ      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  handlers/       â”‚
              â”‚  (ç»Ÿä¸€å¤„ç†å™¨)     â”‚
              â”‚  â€¢ nono_handlers â”‚
              â”‚  â€¢ pet_handlers  â”‚
              â”‚  â€¢ ...           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. æ•°æ®æœåŠ¡å™¨ (start_dataserver.lua)

**èŒè´£ï¼š**
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç”¨æˆ·æ•°æ®
- æä¾› RESTful HTTP API
- ç®¡ç†ä¼šè¯çŠ¶æ€ï¼ˆåœ¨çº¿ç”¨æˆ·ã€NoNo çŠ¶æ€ç­‰ï¼‰
- æ•°æ®æŒä¹…åŒ–

**API ç«¯ç‚¹ï¼š**

#### ç”¨æˆ·æ•°æ®
- `GET /api/user/:id` - è·å–æˆ–åˆ›å»ºç”¨æˆ·
- `POST /api/user/:id` - ä¿å­˜ç”¨æˆ·æ•°æ®
- `PATCH /api/user/:id/:field` - æ›´æ–°ç”¨æˆ·å­—æ®µ

#### ä¼šè¯ç®¡ç†
- `POST /api/session/online` - ç”¨æˆ·ä¸Šçº¿
- `POST /api/session/offline` - ç”¨æˆ·ä¸‹çº¿
- `GET /api/session/online/:id` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨çº¿
- `GET /api/session/online` - è·å–æ‰€æœ‰åœ¨çº¿ç”¨æˆ·

#### NoNo çŠ¶æ€
- `POST /api/nono/following` - è®¾ç½® NoNo è·ŸéšçŠ¶æ€
- `GET /api/nono/following/:id` - è·å– NoNo è·ŸéšçŠ¶æ€

#### ç»Ÿè®¡ä¿¡æ¯
- `GET /api/stats` - è·å–ç»Ÿè®¡ä¿¡æ¯
- `GET /api/health` - å¥åº·æ£€æŸ¥

### 2. æ•°æ®å®¢æˆ·ç«¯ (data_client.lua)

**èŒè´£ï¼š**
- å°è£… HTTP API è°ƒç”¨
- æä¾›åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ¨¡å¼
- é”™è¯¯å¤„ç†å’Œé‡è¯•

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```lua
local DataClient = require('./data_client')
local client = DataClient:new("http://127.0.0.1:5200")

-- å¼‚æ­¥æ¨¡å¼
client:getOrCreateUser(userId, function(success, result)
    if success then
        local user = result.data
        -- å¤„ç†ç”¨æˆ·æ•°æ®
    end
end)

-- åŒæ­¥æ¨¡å¼ï¼ˆä½¿ç”¨åç¨‹ï¼‰
local success, user = client:getUserSync(userId)
```

### 3. ç»Ÿä¸€å‘½ä»¤å¤„ç†å™¨ (handlers/)

**å…³é”®æ”¹è¿›ï¼š**
- âœ… å¤„ç†å™¨åªå†™ä¸€æ¬¡
- âœ… æ¸¸æˆæœåŠ¡å™¨å’Œæˆ¿é—´æœåŠ¡å™¨å…±äº«
- âœ… æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ¨¡å¼
- âœ… é€šè¿‡ DataClient è®¿é—®æ•°æ®

**ä¸Šä¸‹æ–‡å¯¹è±¡ (ctx)ï¼š**
```lua
local ctx = {
    userId = userId,
    cmdId = cmdId,
    body = body,
    
    -- æ•°æ®è®¿é—®ï¼ˆäºŒé€‰ä¸€ï¼‰
    dataClient = dataClient,        -- å¼‚æ­¥æ¨¡å¼ï¼ˆå¾®æœåŠ¡ï¼‰
    getOrCreateUser = function(),   -- åŒæ­¥æ¨¡å¼ï¼ˆå•çª—å£ï¼‰
    saveUser = function(),          -- åŒæ­¥æ¨¡å¼ï¼ˆå•çª—å£ï¼‰
    
    -- å“åº”å‘é€
    sendResponse = function(packet),
    broadcastToMap = function(packet, excludeUserId),
    
    -- ä¼šè¯ç®¡ç†
    sessionManager = sessionManager,  -- å¯é€‰
}
```

### 4. æ¸¸æˆæœåŠ¡å™¨ (start_gameserver.lua)

**æ”¹è¿›ï¼š**
- åˆ›å»º DataClient å®ä¾‹
- ä¼ é€’ç»™å‘½ä»¤å¤„ç†å™¨
- ä¸å†ç›´æ¥è®¿é—® UserDB

**åˆå§‹åŒ–ï¼š**
```lua
local DataClient = require('./data_client')
local dataClient = DataClient:new("http://127.0.0.1:5200")

-- æ„å»ºä¸Šä¸‹æ–‡
local ctx = {
    userId = userId,
    dataClient = dataClient,  -- ä½¿ç”¨ DataClient
    sendResponse = function(packet) ... end,
}
```

### 5. æˆ¿é—´æœåŠ¡å™¨ (start_roomserver.lua)

**æ”¹è¿›ï¼š**
- ä¸æ¸¸æˆæœåŠ¡å™¨å®Œå…¨ç›¸åŒçš„æ¶æ„
- å…±äº«åŒä¸€å¥—å‘½ä»¤å¤„ç†å™¨
- é€šè¿‡ DataClient è®¿é—®æ•°æ®

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. ä»£ç å¤ç”¨
- âœ… å‘½ä»¤å¤„ç†å™¨åªå†™ä¸€æ¬¡
- âœ… æ¸¸æˆæœåŠ¡å™¨å’Œæˆ¿é—´æœåŠ¡å™¨å…±äº«
- âœ… å‡å°‘ç»´æŠ¤æˆæœ¬

### 2. æ•°æ®ä¸€è‡´æ€§
- âœ… æ‰€æœ‰æ•°æ®é›†ä¸­ç®¡ç†
- âœ… é¿å…æ•°æ®ä¸åŒæ­¥é—®é¢˜
- âœ… ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£

### 3. æœåŠ¡éš”ç¦»
- âœ… æ¸¸æˆæœåŠ¡å™¨å´©æºƒä¸å½±å“æˆ¿é—´æœåŠ¡å™¨
- âœ… å¯ä»¥ç‹¬ç«‹é‡å¯
- âœ… æ˜“äºæ‰©å±•å’Œéƒ¨ç½²

### 4. å‘åå…¼å®¹
- âœ… æ”¯æŒåŒæ­¥æ¨¡å¼ï¼ˆå•çª—å£ï¼‰
- âœ… æ”¯æŒå¼‚æ­¥æ¨¡å¼ï¼ˆå¾®æœåŠ¡ï¼‰
- âœ… å¹³æ»‘è¿ç§»

## ğŸ”„ æ•°æ®æµ

### ç”¨æˆ·ç™»å½•æµç¨‹
```
1. å®¢æˆ·ç«¯ â†’ æ¸¸æˆæœåŠ¡å™¨ (CMD 1001)
2. æ¸¸æˆæœåŠ¡å™¨ â†’ æ•°æ®æœåŠ¡å™¨ (GET /api/user/:id)
3. æ•°æ®æœåŠ¡å™¨ â†’ è¿”å›ç”¨æˆ·æ•°æ®
4. æ¸¸æˆæœåŠ¡å™¨ â†’ æ•°æ®æœåŠ¡å™¨ (POST /api/session/online)
5. æ¸¸æˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (ç™»å½•å“åº”)
```

### NoNo è·Ÿéšæµç¨‹
```
1. å®¢æˆ·ç«¯ â†’ æˆ¿é—´æœåŠ¡å™¨ (CMD 9019)
2. æˆ¿é—´æœåŠ¡å™¨ â†’ æ•°æ®æœåŠ¡å™¨ (POST /api/nono/following)
3. æ•°æ®æœåŠ¡å™¨ â†’ æ›´æ–°çŠ¶æ€
4. æˆ¿é—´æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ (å“åº”)
5. å®¢æˆ·ç«¯åˆ‡æ¢åˆ°æ¸¸æˆæœåŠ¡å™¨
6. æ¸¸æˆæœåŠ¡å™¨ â†’ æ•°æ®æœåŠ¡å™¨ (GET /api/nono/following/:id)
7. æ¸¸æˆæœåŠ¡å™¨ â†’ è·å–æœ€æ–°çŠ¶æ€
```

## ğŸ“ è¿ç§»æ­¥éª¤

### é˜¶æ®µ1ï¼šæ•°æ®æœåŠ¡å™¨ âœ…
- [x] åˆ›å»º HTTP API
- [x] å®ç°ç”¨æˆ·æ•°æ®ç®¡ç†
- [x] å®ç°ä¼šè¯ç®¡ç†
- [x] å®ç° NoNo çŠ¶æ€ç®¡ç†

### é˜¶æ®µ2ï¼šæ•°æ®å®¢æˆ·ç«¯ âœ…
- [x] åˆ›å»º DataClient
- [x] å®ç°å¼‚æ­¥ API è°ƒç”¨
- [x] é”™è¯¯å¤„ç†

### é˜¶æ®µ3ï¼šç»Ÿä¸€å¤„ç†å™¨ ğŸ”„
- [x] ä¿®æ”¹ nono_handlers æ”¯æŒ DataClient
- [ ] ä¿®æ”¹å…¶ä»–å¤„ç†å™¨
- [ ] æµ‹è¯•å…¼å®¹æ€§

### é˜¶æ®µ4ï¼šæœåŠ¡å™¨é›†æˆ â³
- [ ] æ¸¸æˆæœåŠ¡å™¨é›†æˆ DataClient
- [ ] æˆ¿é—´æœåŠ¡å™¨é›†æˆ DataClient
- [ ] æµ‹è¯•å®Œæ•´æµç¨‹

### é˜¶æ®µ5ï¼šä¼˜åŒ– â³
- [ ] æ·»åŠ ç¼“å­˜
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] ç›‘æ§å’Œæ—¥å¿—

## ğŸš€ ä½¿ç”¨æ–¹å¼

### å¯åŠ¨æœåŠ¡å™¨
```bash
cd luvit_version
start.bat
```

ä¼šå¯åŠ¨ï¼š
1. æ•°æ®æœåŠ¡å™¨ (5200)
2. èµ„æºæœåŠ¡å™¨ (32400)
3. ç™»å½•IPæœåŠ¡å™¨ (32401)
4. ç™»å½•æœåŠ¡å™¨ (1863)
5. æ¸¸æˆæœåŠ¡å™¨ (5000)
6. æˆ¿é—´æœåŠ¡å™¨ (5100)

### è®¿é—®æ¸¸æˆ
```
http://127.0.0.1:32400/
```

## ğŸ”§ é…ç½®

æ‰€æœ‰æœåŠ¡å™¨å…±äº«é…ç½®ï¼š
```lua
local conf = {
    dataserver_url = "http://127.0.0.1:5200",  -- æ•°æ®æœåŠ¡å™¨åœ°å€
    gameserver_port = 5000,
    roomserver_port = 5100,
}
```

## ğŸ“Š ç›‘æ§

è®¿é—®æ•°æ®æœåŠ¡å™¨ APIï¼š
```bash
# å¥åº·æ£€æŸ¥
curl http://127.0.0.1:5200/api/health

# ç»Ÿè®¡ä¿¡æ¯
curl http://127.0.0.1:5200/api/stats

# åœ¨çº¿ç”¨æˆ·
curl http://127.0.0.1:5200/api/session/online
```

## ğŸ“ æ€»ç»“

è¿™ä¸ªå¾®æœåŠ¡æ¶æ„å®ç°äº†ï¼š
1. **ç»Ÿä¸€çš„å‘½ä»¤å¤„ç†å™¨** - å†™ä¸€æ¬¡ï¼Œåˆ°å¤„ç”¨
2. **é›†ä¸­çš„æ•°æ®ç®¡ç†** - æ•°æ®ä¸€è‡´æ€§ä¿è¯
3. **æœåŠ¡éš”ç¦»** - ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
4. **å‘åå…¼å®¹** - æ”¯æŒå•çª—å£å’Œå¤šçª—å£æ¨¡å¼

ç°åœ¨ä½ å¯ä»¥ä¸“æ³¨äºç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¸ç”¨æ‹…å¿ƒæ•°æ®åŒæ­¥å’Œä»£ç é‡å¤é—®é¢˜ï¼ğŸ‰
