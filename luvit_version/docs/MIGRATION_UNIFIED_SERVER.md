# 服务器架构迁移说明

## 概述

本次更新将**游戏服务器**和**房间服务器**合并为统一的游戏服务器，简化了架构并提高了性能。

## 架构变更

### 之前的架构
```
游戏服务器 (5000) ← 游戏逻辑、地图、战斗
房间服务器 (5100) ← 家园系统、家具
```

### 现在的架构
```
游戏服务器 (5000) ← 所有功能（游戏 + 家园）
```

## 主要变更

### 1. 服务器合并
- ✅ 房间服务器功能已完全集成到游戏服务器
- ✅ 客户端连接家园时直接连接游戏服务器（端口 5000）
- ✅ 不再需要启动独立的房间服务器

### 2. 命令处理
所有家园相关命令现在由游戏服务器处理：
- `CMD 10001` - 家园登录
- `CMD 10002` - 获取房间地址（返回游戏服务器地址）
- `CMD 10003` - 离开房间
- `CMD 10004` - 购买家具
- `CMD 10005` - 出售家具
- `CMD 10006` - 正在使用的家具
- `CMD 10007` - 所有家具
- `CMD 10008` - 设置家具
- `CMD 2324` - 房间精灵列表
- `CMD 2157` - 查看在线状态

### 3. 数据管理
- ✅ 统一的用户数据管理
- ✅ 家具数据存储在用户的 `gameData` 中
- ✅ 不再需要跨服务器数据同步

### 4. 启动脚本
- ✅ `start.bat` 已更新，不再启动房间服务器
- ✅ 启动流程从 5 个服务器减少到 4 个

## 优势

### 1. 简化部署
- 减少了一个服务器进程
- 更少的端口占用
- 更简单的配置

### 2. 提高性能
- 消除了服务器间通信开销
- 统一的数据访问
- 更快的响应速度

### 3. 易于维护
- 单一代码库
- 统一的错误处理
- 更容易调试

### 4. 更好的一致性
- 统一的会话管理
- 统一的数据状态
- 避免数据不同步问题

## 迁移步骤

### 对于开发者

1. **更新代码**
   - 游戏服务器现在包含所有家园功能
   - `localgameserver.lua` 已包含完整的家园系统实现

2. **更新配置**
   - 不再需要 `roomserver_port` 配置
   - `CMD 10002` 返回游戏服务器地址

3. **测试**
   - 启动游戏服务器
   - 测试家园功能
   - 确认所有命令正常工作

### 对于用户

1. **停止旧服务器**
   - 关闭所有正在运行的服务器窗口

2. **启动新服务器**
   ```bash
   cd luvit_version
   start.bat
   ```

3. **验证**
   - 访问 http://127.0.0.1:32400/
   - 登录游戏
   - 测试家园功能

## 文件变更

### 修改的文件
- `luvit_version/gameserver/localgameserver.lua` - 添加家园系统实现
- `luvit_version/start.bat` - 移除房间服务器启动
- `luvit_version/start_gameserver.lua` - 更新说明
- `luvit_version/README.md` - 更新文档

### 废弃的文件
- `luvit_version/start_roomserver.lua` - 不再需要
- `luvit_version/roomserver/localroomserver.lua` - 功能已合并

## 兼容性

### 客户端兼容性
- ✅ 完全兼容现有客户端
- ✅ 所有协议保持不变
- ✅ 无需修改客户端代码

### 数据兼容性
- ✅ 现有用户数据完全兼容
- ✅ 家具数据自动迁移
- ✅ 无需手动数据迁移

## 故障排除

### 问题：无法进入家园
**解决方案：**
- 确认游戏服务器已启动（端口 5000）
- 检查 `CMD 10002` 返回的地址是否正确

### 问题：家具数据丢失
**解决方案：**
- 检查 `users.json` 中的 `fitments` 和 `allFitments` 字段
- 确认数据库保存功能正常

### 问题：NoNo 状态不正确
**解决方案：**
- 会话管理器现在统一管理 NoNo 状态
- 确认 `sessionManager` 正常工作

## 技术细节

### 命令路由
```lua
-- 游戏服务器现在处理所有命令
function LocalGameServer:getLocalHandlers()
    return {
        -- 游戏命令
        [2001] = self.handleEnterMap,
        [2002] = self.handleLeaveMap,
        -- ...
        
        -- 家园命令（已合并）
        [10001] = self.handleRoomLogin,
        [10002] = self.handleGetRoomAddress,
        [10003] = self.handleLeaveRoom,
        [10004] = self.handleBuyFitment,
        [10005] = self.handleBetrayFitment,
        [10006] = self.handleFitmentUsering,
        [10007] = self.handleFitmentAll,
        [10008] = self.handleSetFitment,
        -- ...
    }
end
```

### 数据结构
```lua
-- 用户数据现在包含家具信息
userData = {
    -- 游戏数据
    coins = 10000,
    pets = {...},
    
    -- 家园数据（已合并）
    fitments = {
        {id = 500001, x = 0, y = 0, dir = 0, status = 0}
    },
    allFitments = {
        {id = 500001, usedCount = 1, allCount = 1}
    }
}
```

## 未来计划

- ✅ 服务器合并完成
- 🔄 性能优化
- 🔄 添加更多家园功能
- 🔄 改进数据持久化

## 反馈

如有问题或建议，请在项目中提出 Issue。

---

**更新日期：** 2026-01-18
**版本：** 2.0 - 统一服务器架构
